#!/bin/bash
set -euo pipefail

# Build TypeScript
echo "Building TypeScript..."
npm run build:2.0

rm -rf build
mkdir build

# Check and build each version if it exists
if [ -d "src-1.0" ]; then
  cd src-1.0
  zip -r ../build/make-it-red-1.0.xpi *
  cd ..
fi

if [ -d "src-1.1" ]; then
  cd src-1.1
  zip -r ../build/make-it-red-1.1.xpi *
  cd ..
fi

if [ -d "src-1.2" ]; then
  cd src-1.2
  zip -r ../build/make-it-red-1.2.xpi *
  cd ..
fi

# For src-2.0, create temp directory with compiled JS and other files
if [ -d "src-2.0" ]; then
  mkdir -p build/temp-2.0
  cp src-2.0/build/*.js build/temp-2.0/
  cp src-2.0/manifest.json build/temp-2.0/
  cp src-2.0/prefs.js build/temp-2.0/
  cp src-2.0/style.css build/temp-2.0/
  cp -r src-2.0/locale build/temp-2.0/

  cd build/temp-2.0
  zip -r ../make-it-red-2.0.xpi *
  cd ../..
  rm -rf build/temp-2.0
fi

cd build

# Generate update manifests only if the template and XPI files exist
if [ -f "../updates-1.0.json.tmpl" ] && [ -f "make-it-red-1.1.xpi" ]; then
  jq ".addons[\"make-it-red@example.com\"].updates[0].update_hash = \"sha256:`shasum -a 256 make-it-red-1.1.xpi | cut -d' ' -f1`\"" ../updates-1.0.json.tmpl > updates-1.0.json
  cp updates-1.0.json update.rdf
fi

if [ -f "../updates-1.1.json.tmpl" ] && [ -f "make-it-red-1.2.xpi" ] && [ -f "make-it-red-2.0.xpi" ]; then
  jq ".addons[\"make-it-red@example.com\"].updates[0].update_hash = \"sha256:`shasum -a 256 make-it-red-1.2.xpi | cut -d' ' -f1`\"" ../updates-1.1.json.tmpl | \
    jq ".addons[\"make-it-red@example.com\"].updates[1].update_hash = \"sha256:`shasum -a 256 make-it-red-2.0.xpi | cut -d' ' -f1`\"" > updates-1.1.json
fi

if [ -f "../updates-1.2.json.tmpl" ] && [ -f "make-it-red-1.2.xpi" ] && [ -f "make-it-red-2.0.xpi" ]; then
  jq ".addons[\"make-it-red@example.com\"].updates[0].update_hash = \"sha256:`shasum -a 256 make-it-red-1.2.xpi | cut -d' ' -f1`\"" ../updates-1.2.json.tmpl | \
    jq ".addons[\"make-it-red@example.com\"].updates[1].update_hash = \"sha256:`shasum -a 256 make-it-red-2.0.xpi | cut -d' ' -f1`\"" > updates-1.2.json
fi

if [ -f "../updates-2.0.json.tmpl" ] && [ -f "make-it-red-2.0.xpi" ]; then
  jq ".addons[\"make-it-red@example.com\"].updates[0].update_hash = \"sha256:`shasum -a 256 make-it-red-2.0.xpi | cut -d' ' -f1`\"" ../updates-2.0.json.tmpl > updates-2.0.json
fi

echo "Build complete!"
